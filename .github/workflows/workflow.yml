name: Colcon Test and Coverage

on:
  pull_request:
    branches:
      - dev
      - pre-release
      - release

jobs:
  build:
    runs-on: self-hosted

    steps:

    - name: Setup Docker Container 
      run: | 
        docker pull ros:humble
        
    - name: Run commands inside Docker Container
      run: |
        docker run --name ros-container -i -d ros:humble bash 
        docker exec -i ros-container git clone --recursive --branch dev https://github.com/THI-Drone/thi-drone-ws.git 
        docker exec -i ros-container /bin/bash -c "cd ws-thi-drone/src/demo_package_py && git checkout ${{ github.ref }}"
        docker exec -i ros-container /bin/bash -c "colcon build --symlink-install"
        docker exec -i ros-container /bin/bash -c "colcon test"
        docker exec -i ros-container /bin/bash -c "colcon test-result --all"

    - name: debug
      run: |
        docker exec -i ros-container /bin/bash -c "ls -l /thi-drone-ws/src/demo_package_py/log"
        docker exec -i ros-container /bin/bash -c "cat /thi-drone-ws/src/demo_package_py/log/test_results/test_results.xml"

    - name: Copy logs from container to workspace
      run: |
        docker cp ros-container:/thi-drone-ws/src/demo_package_py/log ./log
    
    - name: Upload build-logs
      uses: actions/upload-artifact@v2
      if: failure()
      with:
        name: build-logs
        path: ./log


